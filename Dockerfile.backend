# Stage 1: Build
# Use a more recent LTS version of Node.js
FROM node:20-alpine AS builder

WORKDIR /app
COPY server/package*.json ./
RUN npm install

COPY server/ .

# Stage 2: Production
# Use the same recent LTS version for the final image
FROM node:20-alpine

WORKDIR /app

COPY --from=builder /app ./

# Create data directory and set permissions
RUN mkdir -p /app/data && chown -R node:node /app/data

USER node

EXPOSE 5000

CMD ["npm", "start"]